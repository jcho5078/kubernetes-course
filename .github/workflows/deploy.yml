name: Deploy to Minikube via Helmfile (NodePort only)

on:
  push:
    branches:
      - master    # master ë¸Œëœì¹˜ push ì‹œ ìë™ ë°°í¬

jobs:
  deploy:
    runs-on: windows-latest    # âœ… Windows í™˜ê²½ ì§€ì •

    steps:
      # âœ… ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # âœ… Helm & Helmfile ì„¤ì¹˜ í™•ì¸ (ì—†ìœ¼ë©´ ì„¤ì¹˜)
      - name: Ensure Helm and Helmfile Installed
        shell: pwsh
        run: |
          # Helm í™•ì¸
          if (-not (Get-Command helm -ErrorAction SilentlyContinue)) {
            Write-Host "ğŸ› ï¸ Helm not found. Installing via Chocolatey..."
            choco install kubernetes-helm -y
          } else {
            Write-Host "âœ… Helm already installed: $(helm version --short)"
          }

          # Helmfile í™•ì¸
          if (-not (Get-Command helmfile -ErrorAction SilentlyContinue)) {
            Write-Host "ğŸ› ï¸ Helmfile not found. Installing..."
            Invoke-WebRequest -Uri https://github.com/helmfile/helmfile/releases/latest/download/helmfile_Windows_amd64.tar.gz -OutFile helmfile.tar.gz
            tar -xzf helmfile.tar.gz
            Move-Item helmfile.exe "C:\Program Files\Helmfile\helmfile.exe" -Force
            $env:Path += ";C:\Program Files\Helmfile"
            Write-Host "âœ… Helmfile installed successfully."
          } else {
            Write-Host "âœ… Helmfile already installed: $(helmfile --version)"
          }

      # âœ… Helmfile sync ì‹¤í–‰ (dev í™˜ê²½)
      - name: Deploy Helmfile
        shell: pwsh
        run: |
          helmfile -e dev sync
          Write-Host "âœ… Helmfile sync completed successfully."

      # âœ… NodePort ì„œë¹„ìŠ¤ í™•ì¸
      - name: Show NodePort Info
        shell: pwsh
        run: |
          kubectl get svc -n dev
          Write-Host "âœ… Copy the NodePort from above and open: http://localhost:<nodeport>"
