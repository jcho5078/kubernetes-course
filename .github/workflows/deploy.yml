name: Deploy to Minikube via Helmfile (NodePort only)

on:
  push:
    branches:
      - master    # master ë¸Œëœì¹˜ push ì‹œ ìë™ ë°°í¬

jobs:
  deploy:
    runs-on: windows-latest    # âœ… Windows í™˜ê²½ ì§€ì •

    steps:
      # âœ… ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # âœ… Helm & Helmfile ì„¤ì¹˜ í™•ì¸ (ì—†ìœ¼ë©´ ì„¤ì¹˜)
      - name: Ensure Helm and Helmfile Installed
        shell: pwsh
        run: |
          # Helm í™•ì¸
          if (-not (Get-Command helm -ErrorAction SilentlyContinue)) {
            Write-Host "ğŸ› ï¸ Helm not found. Installing via Chocolatey..."
            choco install kubernetes-helm -y
          } else {
            Write-Host "âœ… Helm already installed: $(helm version --short)"
          }

          # Helmfile í™•ì¸
          if (Get-Command helmfile -ErrorAction SilentlyContinue) {
              Write-Host "âœ… Helmfile present: $(helmfile --version)"
          } else {
            Write-Host "ğŸ› ï¸ Installing Helmfile..."
            $url = "https://github.com/helmfile/helmfile/releases/latest/download/helmfile_windows_amd64.exe"
            $target = "C:\Program Files\Helmfile\helmfile.exe"
            New-Item -ItemType Directory -Force -Path "C:\Program Files\Helmfile" | Out-Null
            Invoke-WebRequest -Uri $url -OutFile $target
            Write-Host "âœ… Helmfile downloaded successfully."
            echo "C:\Program Files\Helmfile" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

      # âœ… Helmfile sync ì‹¤í–‰ (dev í™˜ê²½)
      - name: Deploy Helmfile
        shell: pwsh
        run: |
          helmfile -e dev sync
          Write-Host "âœ… Helmfile sync completed successfully."

      # âœ… NodePort ì„œë¹„ìŠ¤ í™•ì¸
      - name: Show NodePort Info
        shell: pwsh
        run: |
          kubectl get svc -n dev
          Write-Host "âœ… Copy the NodePort from above and open: http://localhost:<nodeport>"
